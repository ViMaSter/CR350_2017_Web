<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Simple websocket client</title>
	<style type="text/css">
		.player
		{
			position: absolute;
			width: 100px;
			height: 100px;

			background-color: #e27a2d;
		}
	</style>
</head>
<body>
	<button onclick="createSession();">createSession</button>
	<button onclick="joinSession(prompt('specify session ID', -1));">joinSession</button>
	<script type="text/javascript">
		// https://stackoverflow.com/a/5647103
		if (location.hash.length <= 1)
		{
			location.hash = "hostname=127.0.0.1&port=7000";
		}

		let locationHashMap = location.hash.substr(1, location.hash.length-1)
	      .split("&")
	      .map(v => v.split("="))
	      .reduce( (pre, [key, value]) => ({ ...pre, [key]: value }), {} );

	    console.log("Received hashmap %o", locationHashMap);

	    // websocket client connection + event setup
	    const URI = `ws://${locationHashMap.hostname}:${locationHashMap.port}`;
		const websocketClient = new WebSocket(URI);
	    console.log("Connecting to: " + URI);

	    // global parameter required to update correct session
	    let sessionID = -1;
	    let playerID = -1;

		websocketClient.onopen = (openEvent) => {
			console.group("Successfully connected");
			console.log(openEvent);
			console.groupEnd();
		};
		websocketClient.onerror = (errorEvent) => {
			console.group("Error during WebSocket connection");
			console.log(errorEvent);
			console.groupEnd();
		};
		websocketClient.onmessage = (messageEvent) => {
			console.group("New message");
			console.log(messageEvent);
			console.groupEnd();

			const parsedMessage = JSON.parse(messageEvent.data);
			switch(parsedMessage.command)
			{
				case "sessionJoin":
					sessionID = parsedMessage.sessionID;
					playerID = parsedMessage.playerID;
					playerJoin(parsedMessage.playerID, parsedMessage.player);
					break;
				case "playerJoin":
					playerJoin(parsedMessage.playerID, parsedMessage.player);
					break;
				case "playerUpdate":
					playerUpdate(parsedMessage.playerID, parsedMessage.player);
					break;
			}
		};
		let players = {};

		const joinSession = (sessionID) =>
		{
			websocketClient.send('{"command":"joinSession","sessionID":'+sessionID+'}');
		}
		const createSession = (sessionID) =>
		{
			websocketClient.send('{"command":"createSession","session":{"mapName":"castle","timelimit":180000,"currentMatchStart":1543943190000},"player":{"name":"NowYouSeeMe","position":{"x":0.0,"y":0.0},"colorHex":2980578}}');
		}
		const playerJoin = (ID, playerInfo) =>
		{
			console.log("NEW PLAYER " + ID);
			players[ID] = new Player(ID);
			players[ID].Update(playerInfo);
		};
		const playerLeave = (ID) =>
		{
			delete players[ID];
		}
		const playerUpdate = (ID, playerInfo) =>
		{
			console.log("UPDATE FOR PLAYER " + ID);
			players[ID].Update(playerInfo);
		};

		setInterval(() => 
		{
			Object.values(players).forEach((player) => {
				player.Render();
			});
		}, (1/60) * 100);
	</script>
	<script type="text/javascript">
		window.addEventListener("keypress", (keydownevent) =>
		{
			switch (keydownevent.key)
			{
				case "w":
					nudgePlayer(0, 1);
					break;
				case "s":
					nudgePlayer(0, -1);
					break;
				case "a":
					nudgePlayer(-1, 0);
					break;
				case "d":
					nudgePlayer(1, 0);
					break;
			}
		});

		const nudgePlayer = (x, y) =>
		{
			const newX = players[playerID].position.x + x;
			const newY = players[playerID].position.y + y;

			sendUpdate(newX, newY);
		};

		const sendUpdate = (x, y) =>
		{
			websocketClient.send(JSON.stringify({
				"command": "updatePlayer",
				"player": {
					"name": players[playerID].name,
					"position": {
						"x": x,
						"y": y
					},
					"colorHex": players[playerID].color
				}
			}));
		};

		class Player
		{
			constructor(ID)
			{
				this.ID = ID;
				this.name = "";
				this.color = -1;
				this.position = {x: -1, y: -1}

				this.element = document.createElement("div");
				document.body.appendChild(this.element);
				this.element.style.left = "-5000px";
				this.element.style.top = "-5000px";
				this.element.classList.add("player");
				this.element.classList.add("player-"+ID);
			}

			Render()
			{
				this.element.style.left =	this.position.x * 5 + "px";
				this.element.style.top = -this.position.y * 5 + "px";
			}

			Update(updateInfo)
			{
				this.name = updateInfo.name;
				this.color = updateInfo.colorHex;
				this.position.x = updateInfo.position.x;
				this.position.y = updateInfo.position.y;
			}
		};
	</script>
</body>
</html>